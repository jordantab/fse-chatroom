<!DOCTYPE html>
<html>
  <head>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>FSE Chatroom</title>
  </head>
  <body>
    <h1>Welcome to the FSE Chatroom</h1>
    <form action="/logout" method="POST">
      <button type="submit">Logout</button>
    </form>
    <ul id="messages">
      <% messages.forEach(function(message) { %>
        <li><%= message.username %>: <%= message.text%>  <%= message.timestamp%></li>
      <% }); %>
    </ul>
    <script>
      const username = '<%= user.username %>';
    </script>
    <form id="chatForm">
      <input type="text" id="message" name="message" required>
      <button type="submit">Send</button>
    </form>
    <script>
      var socket = io();
      socket.on('connect', function() {
        console.log('Connected to server');
      });
      socket.on('disconnect', function() {
        console.log('Disconnected from server');
      })

      $('#chatForm').submit(function(e) {
        e.preventDefault()

        let messageData = {
          username: username,
          text: $('#message').val(),
          timestamp: new Date()
        };

        // emits a 'chat message' event to the server with the value of the input field as data
        socket.emit('chat message', messageData);

        // clears the input field
        $('#message').val('');

        return false
      });

      // Listen for a 'new message' event from the server
      socket.on('new message', function(message) {
        // Append the new message to the list
        $('#messages').append($('<li>').text(message.username + ': ' + message.text + '  ' + new Date(message.timestamp).toString()))
      })

    </script>
  </body>
</html>
